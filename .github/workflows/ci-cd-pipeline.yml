name: CI/CD Pipeline

on:
  push:
    branches:
      - master  # master 브랜치에 푸시될 때마다 실행

jobs:
  build:
    runs-on: ubuntu-latest  # Ubuntu 환경에서 실행

    steps:
      # 1. 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Java 21 설치 (Gradle 빌드를 위해 Java 21 필요)
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'zulu'  # zulu를 사용하여 Java 21 설치
          java-package: jdk

      # 3. Gradle Wrapper에 실행 권한 부여
      - name: Give execute permission to gradlew
        run: chmod +x ./gradlew  # gradlew에 실행 권한 부여

      # 4. Gradle 빌드 실행
      - name: Build with Gradle
        run: ./gradlew build  # .jar 파일을 build/libs/에 생성

      # 5. MySQL 설치 및 설정
      - name: Set up MySQL
        uses: samin/mysql-action@v1
        with:
          mysql-version: '8.0'
          mysql-db: testdatabase
          mysql-root-password: jj6907**  # root 비밀번호 설정
          mysql-user: testuser
          mysql-password: testpassword

      # 6. Docker Compose 설치
      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # 7. Docker Hub 로그인 (DOCKER_USERNAME과 DOCKER_PASSWORD 사용)
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 8. Docker Compose 빌드 및 실행
      - name: Build and run with Docker Compose
        run: |
          docker-compose -f docker-compose.yml up --build -d

  deploy:
    runs-on: ubuntu-latest  # 배포 작업을 실행할 환경
    needs: build  # 빌드가 완료된 후에 배포 시작

    steps:
      # 9. SSH 연결을 설정하고 서버에 배포
      - name: Deploy to server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # SSH 키 권한 설정
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -t kbs77@${{ secrets.SERVER_IP }} << "EOF"
          cd /home/kbs77/project  # 배포 디렉토리로 이동
          git pull origin master  # 최신 코드 받아오기
          docker-compose -f docker-compose.yml down  # 기존 컨테이너 종료
          docker-compose -f docker-compose.yml up -d  # 새로운 컨테이너 실행
          EOF
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # SSH 키를 환경 변수로 전달

